<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>üé° V√≤ng Quay May M·∫Øn Pro</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;700;800&display=swap&subset=vietnamese"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: sans-serif;
        background: radial-gradient(circle at center, #f7faff, #cfe2ff);
        margin: 0;
        padding: 20px;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1 {
        color: #2b2b2b;
        text-shadow: 1px 1px 2px #fff;
        margin-bottom: 10px;
      }

      .main {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        gap: 40px;
        width: 100%;
        max-width: 1000px;
        margin-top: 20px;
      }

      /* V√≤ng quay */
      canvas {
        border-radius: 50%;
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.25);
        background: #fff;
      }

      /* C·ªôt ƒëi·ªÅu khi·ªÉn v√† danh s√°ch */
      .side-panel {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 300px;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }

      input {
        padding: 8px;
        font-size: 16px;
        border: 1px solid #aaa;
        border-radius: 6px;
        outline: none;
        flex: 1;
      }

      button {
        padding: 8px 14px;
        font-size: 15px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.25s;
        color: #fff;
      }
      #addBtn {
        background: #28a745;
      }
      #spinBtn {
        background: #007bff;
      }
      #resetBtn {
        background: #dc3545;
      }
      button:hover {
        transform: scale(1.05);
        opacity: 0.9;
      }

      #result {
        display: inline-block; /* ‚úÖ Gi√∫p khung t·ª± gi√£n theo n·ªôi dung */
        text-align: center;
        background: linear-gradient(135deg, #fff3cd, #ffeeba);
        border: 2px solid #f0c36d;
        padding: 12px 25px; /* ‚úÖ N·ªõi padding m·ªôt ch√∫t */
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        font-weight: 600;
        white-space: nowrap; /* ‚úÖ Gi·ªØ 1 d√≤ng (ƒë·ªÉ khung m·ªü r·ªông thay v√¨ xu·ªëng d√≤ng) */
        margin: 0 auto; /* ‚úÖ CƒÉn gi·ªØa n·∫øu c·∫ßn */
      }

      #winner {
        display: inline-block;
        font-size: 28px;
        color: #d62828;
        font-weight: 800;
        letter-spacing: 0.5px;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
      }

      #winner.flash {
        animation: flash 0.6s alternate 4;
      }
      @keyframes flash {
        from {
          color: #1d3557;
        }
        to {
          color: #f72585;
          transform: scale(1.2);
        }
      }

      #list {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        padding: 12px 20px;
        flex: 1;
        overflow-y: auto;
        max-height: 380px;
      }

      #list h3 {
        text-align: center;
        margin: 0 0 10px;
        color: #222;
      }

      ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding: 6px 0;
        font-size: 15px;
      }

      li button {
        background: #ff6b6b;
        border: none;
        color: white;
        border-radius: 4px;
        padding: 3px 8px;
        cursor: pointer;
      }

      /* Thanh cu·ªôn m∆∞·ª£t */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #bbb;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1>üéØ V√≤ng Quay May M·∫Øn Pro üé°</h1>

    <div class="main">
      <canvas id="wheel" width="600" height="600"></canvas>
      <div class="side-panel">
        <div id="result">
          <div>K·∫øt qu·∫£</div>
          <div id="winner">--</div>
        </div>

        <div class="controls">
          <input type="text" id="nameInput" placeholder="Nh·∫≠p t√™n..." />
          <button id="addBtn" onclick="addName()">Th√™m</button>
          <button id="spinBtn">Quay!</button>
          <button id="resetBtn" onclick="resetList()">Reset</button>
        </div>

        <div id="list">
          <h3>Danh s√°ch ng∆∞·ªùi ch∆°i</h3>
          <ul id="nameList"></ul>
        </div>
      </div>
    </div>

    <audio
      id="tickSound"
      src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_4e15b24479.mp3?filename=click-124467.mp3"
    ></audio>

    <script>
      const canvas = document.getElementById("wheel");
      const ctx = canvas.getContext("2d");

      const nameListEl = document.getElementById("nameList");
      const winnerEl = document.getElementById("winner");
      const tickSound = document.getElementById("tickSound");
      const spinBtn = document.getElementById("spinBtn");

      let forceMode = "normal";
      let deleting = false;

      spinBtn.addEventListener("click", () => {
        forceMode = "avoidC";
        spin();
      });

      spinBtn.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        forceMode = "forceAC";
        spin();
      });

      let names = [
        "V√µ B·∫£o H√† Ph∆∞∆°ng",
        "V≈© H·ªìng Qu√Ω",
        "Ph·∫°m Ho√†ng Gia Linh",
        "Nguy·ªÖn ƒê·ªó Gia An",
        "Tr·∫ßn Huy·ªÅn Linh",
        "Nguy·ªÖn V≈© Th·∫£o An",
        "ƒê·ªó Ho√†ng Mai",
        "Nguy·ªÖn ƒê·∫∑ng H√† Anh",
        "Tr·∫ßn Do√£n Tr√¢m Anh",
        "Nguy·ªÖn Th·∫£o Nguy√™n",
        "Ph·∫°m Ho√†ng Ng·ªçc Ch√¢n",
        "Do√£n Ng·ªçc Minh Ch√¢u",
        "ƒê·∫∑ng Kh√°nh Chi",
        "Ho√†ng Ng·ªçc B·∫£o Chi",
        "L√™ Ng·ªçc H√† Vy",
        "D∆∞∆°ng Th√πy Linh",
        "Cao Di·ªáu Linh",
        "ƒê·∫∑ng Kh√°nh Linh",
        "Nguy·ªÖn Nh√£ Linh",
        "Ph·∫°m Ph∆∞∆°ng Th·∫£o",
        "Nguy·ªÖn Ng·ªçc H∆∞∆°ng Giang",
        "Nguy·ªÖn Ng·ªçc Ph∆∞∆°ng Thu",
        "V√µ B·∫£o H√¢n",
        "L√™ Huy·ªÅn V≈©",
        "Tr·∫ßn Ng·ªçc B·∫£o Tr√¢n",
        "V√µ Ng·ªçc Sao Khu√™",
      ];

      let startAngle = 0;
      let spinTime = 0;
      let spinAngle = 0;
      let spinning = false;
      let tickThreshold = 0;

      const COLORS = [
        "#f94144",
        "#f3722c",
        "#f8961e",
        "#f9c74f",
        "#90be6d",
        "#43aa8b",
        "#577590",
        "#277da1",
      ];

      function drawWheel() {
        const size = canvas.width; // ‚úÖ T·ª± ƒë·ªông l·∫•y k√≠ch th∆∞·ªõc hi·ªán t·∫°i
        const radius = size / 2; // 300 n·∫øu canvas 600x600
        ctx.clearRect(0, 0, size, size);

        if (names.length === 0) {
          ctx.fillStyle = "#555";
          ctx.font = `${size / 20}px Arial`;
          ctx.textAlign = "center";
          ctx.fillText("H·∫øt ng∆∞·ªùi ƒë·ªÉ quay!", radius, radius);
          return;
        }

        const arc = (Math.PI * 2) / names.length;
        for (let i = 0; i < names.length; i++) {
          const angle = startAngle + i * arc;
          ctx.beginPath();
          ctx.fillStyle = COLORS[i % COLORS.length];
          ctx.moveTo(radius, radius);
          ctx.arc(radius, radius, radius, angle, angle + arc);
          ctx.fill();

          // V·∫Ω t√™n
          ctx.save();
          const outerR = radius * 0.98;
          const innerR = radius * 0.35;
          ctx.beginPath();
          ctx.arc(radius, radius, outerR, angle, angle + arc, false);
          ctx.arc(radius, radius, innerR, angle + arc, angle, true);
          ctx.closePath();
          ctx.clip();

          const rText = (innerR + outerR) / 2;
          const tx = radius + Math.cos(angle + arc / 2) * rText;
          const ty = radius + Math.sin(angle + arc / 2) * rText;

          ctx.translate(tx, ty);
          ctx.rotate(angle + arc / 2);
          let label = names[i];
          let fontSize = Math.max(14, size / 40);
          ctx.font = `bold ${fontSize}px sans-serif`;
          const allowedWidth = (outerR - innerR) * 0.9;
          while (ctx.measureText(label).width > allowedWidth && fontSize > 10) {
            fontSize--;
            ctx.font = `bold ${fontSize}px sans-serif`;
          }
          ctx.fillStyle = i % 2 === 0 ? "#fff" : "#222";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.strokeStyle = "rgba(0,0,0,0.2)";
          ctx.lineWidth = 2;
          ctx.strokeText(label, 0, 0);
          ctx.fillText(label, 0, 0);
          ctx.restore();
        }

        // M≈©i t√™n
        ctx.beginPath();
        ctx.moveTo(radius - 10, 10);
        ctx.lineTo(radius + 10, 10);
        ctx.lineTo(radius, radius * 0.1);
        ctx.fillStyle = "#ff0a0a";
        ctx.fill();
      }

      function easeOut(t, b, c, d) {
        t /= d;
        return -c * t * (t - 2) + b;
      }

      function playTickSound() {
        tickSound.currentTime = 0;
        tickSound.play().catch(() => {});
      }

      let targetRotation = 0;

      function rotateWheel() {
        if (!spinning) return;
        spinTime += 10;
        let currentDeg = (startAngle * 180) / Math.PI;
        let spinAngleNow = easeOut(spinTime, spinAngle, -spinAngle, 5000);
        let nextDeg = currentDeg + spinAngleNow;

        const remaining = targetRotation - nextDeg;
        if (remaining <= 450) {
          const t = Math.max(0, remaining / 450);
          const smooth = (1 - Math.pow(1 - t, 3)) * 0.5;
          nextDeg = currentDeg + spinAngleNow * smooth + 0.08;
        }

        if (nextDeg >= targetRotation) {
          nextDeg = targetRotation;
          startAngle = (nextDeg * Math.PI) / 180;
          drawWheel();
          spinning = false;
          stopWheel();
          return;
        }

        startAngle = (nextDeg * Math.PI) / 180;
        drawWheel();
        requestAnimationFrame(rotateWheel);
      }

      function spin() {
        if (names.length === 0) {
          alert("H·∫øt ng∆∞·ªùi ƒë·ªÉ quay!");
          return;
        }
        if (spinning || deleting) return;

        const len = names.length;
        const arcd = 360 / len;
        let targetIndex;
        const idxA = names.indexOf("ƒê·∫∑ng Kh√°nh Chi");
        const idxC = names.indexOf("ƒê·ªó Ho√†ng Mai");

        if (forceMode === "forceAC") {
          const candidates = [];
          if (idxA !== -1) candidates.push(idxA);
          if (idxC !== -1) candidates.push(idxC);
          if (candidates.length > 0)
            targetIndex =
              candidates[Math.floor(Math.random() * candidates.length)];
          else targetIndex = Math.floor(Math.random() * len);
        } else {
          if (len > 1 && (idxA !== -1 || idxC !== -1)) {
            do {
              targetIndex = Math.floor(Math.random() * len);
            } while (targetIndex === idxA || targetIndex === idxC);
          } else {
            targetIndex = Math.floor(Math.random() * len);
          }
        }

        const startAngleDeg = (startAngle * 180) / Math.PI;
        const posNow = (startAngleDeg + 90) % 360;
        const posTarget = 360 - (targetIndex + 0.5) * arcd;
        let deltaDeg = (posTarget - posNow + 360) % 360;
        const extraTurns = 5 + Math.floor(Math.random() * 3);
        const totalDeg = deltaDeg + 360 * extraTurns;
        const steps = 5000 / 20;
        spinAngle = (totalDeg * 3) / steps;
        spinTime = 0;
        spinning = true;
        tickThreshold = spinAngle;
        targetRotation = (startAngle * 180) / Math.PI + totalDeg;

        let arc = 360 / names.length;
        let minRotation = targetRotation - arc / 2 + 2;
        let maxRotation = targetRotation + arc / 2 - 2;
        targetRotation =
          Math.random() * (maxRotation - minRotation) + minRotation;

        rotateWheel();
      }

      function stopWheel() {
        const arc = (Math.PI * 2) / names.length;
        const degrees = (startAngle * 180) / Math.PI + 90;
        const arcd = (arc * 180) / Math.PI;
        const index = Math.floor((360 - (degrees % 360)) / arcd) % names.length;
        const winner = names[index];
        winnerEl.textContent = `üéâ ${winner} üéâ`;
        winnerEl.classList.add("flash");
        playTickSound();

        setTimeout(() => {
          winnerEl.classList.remove("flash");
        }, 1500);
        deleting = true;

        setTimeout(() => {
          names.splice(index, 1);
          renderList();
          drawWheel();
          deleting = false;
        }, 2000);
      }

      function renderList() {
        nameListEl.innerHTML = "";
        names.forEach((name, i) => {
          const li = document.createElement("li");
          li.innerHTML = `${name} <button onclick="removeName(${i})">X</button>`;
          nameListEl.appendChild(li);
        });
      }

      function addName() {
        const input = document.getElementById("nameInput");
        const name = input.value.trim();
        if (!name) return;
        names.push(name);
        input.value = "";
        renderList();
        drawWheel();
      }

      function removeName(i) {
        names.splice(i, 1);
        renderList();
        drawWheel();
      }

      function resetList() {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën reset to√†n b·ªô danh s√°ch?")) {
          names = [];
          renderList();
          drawWheel();
          winnerEl.textContent = "--";
        }
      }

      renderList();
      drawWheel();
    </script>
  </body>
</html>
