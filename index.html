<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>V√≤ng Quay May M·∫Øn Pro</title>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: radial-gradient(circle at center, #f7faff, #d0e2ff);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
      }

      h1 {
        color: #2b2b2b;
        margin-bottom: 10px;
        text-shadow: 1px 1px 2px #fff;
      }

      canvas {
        border-radius: 50%;
        margin-top: 30px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.2);
        background: #fff;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
      }

      input {
        padding: 8px;
        font-size: 16px;
        border: 1px solid #aaa;
        border-radius: 6px;
        outline: none;
      }

      button {
        padding: 8px 14px;
        font-size: 15px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.25s;
        color: #fff;
      }
      #addBtn {
        background: #28a745;
      }
      #spinBtn {
        background: #007bff;
      }
      #resetBtn {
        background: #dc3545;
      }

      button:hover {
        transform: scale(1.05);
        opacity: 0.9;
      }

      #list {
        margin-top: 20px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        padding: 12px 20px;
        width: 320px;
      }

      #list h3 {
        text-align: center;
        margin: 0 0 10px;
        color: #222;
      }

      ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding: 6px 0;
      }

      li button {
        background: #ff6b6b;
        border: none;
        color: white;
        border-radius: 4px;
        padding: 3px 8px;
        cursor: pointer;
      }

      #result {
        margin-top: 10px;
        font-size: 24px;
        font-weight: bold;
        color: #d62828;
        background: #fff3cd;
        border: 2px solid #f0c36d;
        padding: 10px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      #winner {
        color: #1d3557;
      }

      #winner {
        font-size: 28px;
        color: #1d3557;
        font-weight: bold;
        margin-top: 10px;
        transition: 0.3s;
      }

      #winner.flash {
        animation: flash 0.6s alternate 4;
      }

      @keyframes flash {
        from {
          color: #1d3557;
        }
        to {
          color: #f72585;
          transform: scale(1.2);
        }
      }
    </style>
  </head>
  <body>
    <h1>üé° V√≤ng Quay May M·∫Øn Pro üéØ</h1>
    <div id="result">
      <div>K·∫øt qu·∫£</div>
      <div id="winner">--</div>
    </div>
    <div class="controls">
      <input type="text" id="nameInput" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi ch∆°i..." />
      <button id="addBtn" onclick="addName()">Th√™m</button>
      <button id="spinBtn">Quay!</button>
      <button id="resetBtn" onclick="resetList()">Reset</button>
    </div>

    <canvas id="wheel" width="400" height="400"></canvas>

    <div id="list">
      <h3>Danh s√°ch ng∆∞·ªùi ch∆°i</h3>
      <ul id="nameList"></ul>
    </div>

    <audio
      id="tickSound"
      src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_4e15b24479.mp3?filename=click-124467.mp3"
    ></audio>

    <script>
      const canvas = document.getElementById("wheel");
      const ctx = canvas.getContext("2d");
      const nameListEl = document.getElementById("nameList");
      const winnerEl = document.getElementById("winner");
      const tickSound = document.getElementById("tickSound");
      const spinBtn = document.getElementById("spinBtn");
      let forceMode = "normal";
      let deleting = false;

      spinBtn.addEventListener("click", () => {
        forceMode = "avoidC";
        spin();
      });

      spinBtn.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        forceMode = "forceAC";
        spin();
      });

      let names = [
         "V√µ B·∫£o H√† Ph∆∞∆°ng",
  "V√µ H·ªìng Qu·ª≥",
  "Ph·∫°m Ho√†ng Gia Linh",
  "Nguy·ªÖn ƒê·ªó Gia An",
  "Tr·∫ßn Huy·ªÅn Linh",
  "Nguy·ªÖn V≈© Th·∫£o An",
  "ƒê·ªó Ho√†ng Mai",
  "Nguy·ªÖn ƒêƒÉng H·∫° Anh",
  "Tr·∫ßn Do√£n Tr√† Anh",
  "Nguy·ªÖn Th·∫£o Nguy√™n",
  "Ph·∫°m Ho√†ng Ng·ªçc Ch√¢n",
  "Do√£n Ng·ªçc Minh Ch√¢u",
  "ƒê·∫∑ng Kh√°nh Chi",
  "Ho√†ng Ng·ªçc B·∫£o Chi",
  "L√™ Ng·ªçc H√† Vy",
  "D∆∞∆°ng Th√πy Linh",
  "Cao Di·ªáu Linh",
  "ƒê·∫∑ng Kh√°nh Linh",
  "Nguy·ªÖn Nh√£ Linh",
  "Ph·∫°m Ph∆∞∆°ng Th·∫£o",
  "Nguy·ªÖn Ng·ªçc H∆∞∆°ng Giang",
  "Nguy·ªÖn Ng·ªçc Ph∆∞∆°ng Thu",
  "V√µ B·∫£o H√¢n",
  "L√™ Huy·ªÅn V≈©",
  "Tr·∫ßn Ng·ªçc B·∫£o Tr√¢n",
  "V√µ Ng·ªçc Sao Khu√™"
      ];

      let startAngle = 0;
      let spinTime = 0;
      let spinAngle = 0;
      let spinning = false;
      let tickThreshold = 0;

      function drawWheel() {
        ctx.clearRect(0, 0, 400, 400);
        if (names.length === 0) {
          ctx.fillStyle = "#555";
          ctx.font = "20px Arial";
          ctx.textAlign = "center";
          ctx.fillText("H·∫øt ng∆∞·ªùi ƒë·ªÉ quay!", 200, 200);
          return;
        }

        const arc = (Math.PI * 2) / names.length;
        for (let i = 0; i < names.length; i++) {
          const angle = startAngle + i * arc;
          ctx.beginPath();
          ctx.fillStyle = i % 2 === 0 ? "#ffd166" : "#f4a261";
          ctx.moveTo(200, 200);
          ctx.arc(200, 200, 200, angle, angle + arc);
          ctx.fill();

          // ctx.save();
          // ctx.translate(
          //   200 + Math.cos(angle + arc / 2) * 120,
          //   200 + Math.sin(angle + arc / 2) * 120
          // );
          // ctx.rotate(angle + arc / 2 + Math.PI / 2);
          // ctx.fillStyle = "#222";
          // ctx.font = "bold 16px Poppins";
          // ctx.fillText(names[i], -ctx.measureText(names[i]).width / 2, 0);
          // ctx.restore();
          // --- V·∫º CH·ªÆ D·ªåC THEO √î (m·ªôt d√≤ng, c√≥ clip wedge) ---
          ctx.save();

          // Clip theo h√¨nh mi·∫øng b√°nh (v√†nh ngo√†i/ trong) ƒë·ªÉ ·∫©n ph·∫ßn tr√†n
          const outerR = 196; // b√°n k√≠nh ngo√†i (ch·ª´a vi·ªÅn)
          const innerR = 70; // b√°n k√≠nh trong (ch·ª´a n√∫t gi·ªØa)
          ctx.beginPath();
          ctx.arc(200, 200, outerR, angle, angle + arc, false);
          ctx.arc(200, 200, innerR, angle + arc, angle, true);
          ctx.closePath();
          ctx.clip();

          // V·ªã tr√≠ ch·ªØ ƒë·∫∑t gi·ªØa mi·∫øng (theo b√°n k√≠nh)
          const rText = (innerR + outerR) / 2; // t√¢m d·∫£i ch·ªØ theo b√°n k√≠nh
          const tx = 200 + Math.cos(angle + arc / 2) * rText;
          const ty = 200 + Math.sin(angle + arc / 2) * rText;

          // Xoay NGUY√äN D√íNG theo h∆∞·ªõng b√°n k√≠nh (d·ªçc theo √¥)
          ctx.translate(tx, ty);
          ctx.rotate(angle + arc / 2);

          // Fit c·ª° ch·ªØ theo b·ªÅ r·ªông d·∫£i theo b√°n k√≠nh
          let label = names[i];
          let fontSize = 14;
          ctx.font = `bold ${fontSize}px Poppins`;
          const allowedWidth = (outerR - innerR) * 0.9; // b·ªÅ r·ªông d·∫£i theo b√°n k√≠nh
          while (ctx.measureText(label).width > allowedWidth && fontSize > 9) {
            fontSize--;
            ctx.font = `bold ${fontSize}px Poppins`;
          }

          ctx.fillStyle = "#222";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(label, 0, 0);

          ctx.restore();
          // --- H·∫æT V·∫º CH·ªÆ ---
        }

        // M≈©i t√™n
        ctx.beginPath();
        ctx.moveTo(190, 5);
        ctx.lineTo(210, 5);
        ctx.lineTo(200, 35);
        ctx.fillStyle = "red";
        ctx.fill();
      }

      function easeOut(t, b, c, d) {
        t /= d;
        return -c * t * (t - 2) + b;
      }

      function playTickSound() {
        tickSound.currentTime = 0;
        tickSound.play().catch(() => {});
      }

      let targetRotation = 0; // th√™m bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u g√≥c ƒë√≠ch

      function rotateWheel() {
        if (!spinning) return;

        spinTime += 10;
        let currentDeg = (startAngle * 180) / Math.PI;
        let spinAngleNow = easeOut(spinTime, spinAngle, -spinAngle, 5000);
        let nextDeg = currentDeg + spinAngleNow;

        // ‚úÖ Ultra Smooth Motion ‚Äì deceleration theo kho·∫£ng c√°ch
        const remaining = targetRotation - nextDeg;

        if (remaining <= 450) {
          const t = Math.max(0, remaining / 450); // t t·ª´ 1 -> 0
           const smooth = (1 - Math.pow(1 - t, 3))*0.5;
          nextDeg = currentDeg + spinAngleNow * smooth + 0.08; // gi·ªØ l·ª±c 1 t√≠
        }
        

        // ‚úÖ Ch·ªët cu·ªëi
        if (nextDeg >= targetRotation) {
          nextDeg = targetRotation;
          startAngle = (nextDeg * Math.PI) / 180;
          drawWheel();
          spinning = false;
          stopWheel();
          return;
        }

        startAngle = (nextDeg * Math.PI) / 180;
        drawWheel();
        requestAnimationFrame(rotateWheel);
      }

      function spin() {
        if (names.length === 0) {
          alert("H·∫øt ng∆∞·ªùi ƒë·ªÉ quay!");
          return;
        }

        if (spinning || deleting) return;

        const len = names.length;
        const arcd = 360 / len;

        // --------- CH·ªåN √î K·∫æT QU·∫¢ -------------
        let targetIndex;
        const idxA = names.indexOf("ƒê·∫∑ng Kh√°nh Chi");
        const idxC = names.indexOf("ƒê·ªó Ho√†ng Mai");

        if (forceMode === "forceAC") {
          // Chu·ªôt ph·∫£i √©p v√†o A ho·∫∑c C n·∫øu c√≤n
          const candidates = [];
          if (idxA !== -1) candidates.push(idxA);
          if (idxC !== -1) candidates.push(idxC);

          if (candidates.length > 0) {
            targetIndex =
              candidates[Math.floor(Math.random() * candidates.length)];
          } else {
            // Kh√¥ng c√≤n A, C -> random b√¨nh th∆∞·ªùng
            targetIndex = Math.floor(Math.random() * len);
          }
        } else {
          // Chu·ªôt tr√°i n√© A v√† C
          if (len > 1 && (idxA !== -1 || idxC !== -1)) {
            do {
              targetIndex = Math.floor(Math.random() * len);
            } while (targetIndex === idxA || targetIndex === idxC);
          } else {
            targetIndex = Math.floor(Math.random() * len);
          }
        }
        // --------------------------------------

        // G√≥c hi·ªán t·∫°i
        const startAngleDeg = (startAngle * 180) / Math.PI;
        const posNow = (startAngleDeg + 90) % 360;

        // G√≥c m·ª•c ti√™u
        const posTarget = 360 - (targetIndex + 0.5) * arcd;

        // Quay theo chi·ªÅu t·ª± nhi√™n
        let deltaDeg = (posTarget - posNow + 360) % 360;

        // Th√™m v√≤ng quay cho ƒë·∫πp
        const extraTurns = 5 + Math.floor(Math.random() * 3); // 5‚Äì7 v√≤ng
        const totalDeg = deltaDeg + 360 * extraTurns;

        // Gi·ªØ easing nh∆∞ c≈©
        const steps = 5000 / 20;
        spinAngle = (totalDeg * 3) / steps;

        spinTime = 0;
        spinning = true;
        tickThreshold = spinAngle;
        targetRotation = (startAngle * 180) / Math.PI + totalDeg;

        let arc = 360 / names.length;
        let minRotation = targetRotation - arc / 2 + 2;
        let maxRotation = targetRotation + arc / 2 - 2;

        targetRotation =
          Math.random() * (maxRotation - minRotation) + minRotation;

        rotateWheel();
      }

      function stopWheel() {
        const arc = (Math.PI * 2) / names.length;
        const degrees = (startAngle * 180) / Math.PI + 90;
        const arcd = (arc * 180) / Math.PI;
        const index = Math.floor((360 - (degrees % 360)) / arcd) % names.length;
        const winner = names[index];
        winnerEl.textContent = `üéâ ${winner} üéâ`;
        winnerEl.classList.add("flash");

        // √Çm thanh v√† highlight 1 ch√∫t
        playTickSound();
        setTimeout(() => {
          winnerEl.classList.remove("flash");
        }, 1500);
        deleting = true;

        // Xo√° ng∆∞·ªùi tr√∫ng sau 2s
        setTimeout(() => {
          names.splice(index, 1);
          renderList();

          drawWheel();
          deleting = false;
        }, 2000);
      }

      // Danh s√°ch
      function renderList() {
        nameListEl.innerHTML = "";
        names.forEach((name, i) => {
          const li = document.createElement("li");
          li.innerHTML = `${name} <button onclick="removeName(${i})">X</button>`;
          nameListEl.appendChild(li);
        });
      }

      function addName() {
        const input = document.getElementById("nameInput");
        const name = input.value.trim();
        if (!name) return;
        names.push(name);
        input.value = "";
        renderList();
        drawWheel();
      }

      function removeName(i) {
        names.splice(i, 1);
        renderList();
        drawWheel();
      }

      function resetList() {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën reset to√†n b·ªô danh s√°ch?")) {
          names = [];
          renderList();
          drawWheel();
          winnerEl.textContent = "--";
        }
      }

      renderList();
      drawWheel();
    </script>
  </body>
</html>

